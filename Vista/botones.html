<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <title>Document</title>
</head>

<body id="principal">

    <div class="botones">
        <h1>Bienvenid@ <span id="nombreUsuario"></span> </h1>
        <!-- Contenedor para mostrar los servicios del usuario -->
            <form id="formularioSeleccionServicio"
                <h2>Servicios del Usuario</h2>
                <table id="tabla-servicios">
                    <thead>
                        <tr>
                            <th>Nombre de Servicio</th>
                            <th>Descripci√≥n de Servicio</th>
                            <th>Agregar</th>
                        </tr>
                    </thead>
                    <tbody id="lista-servicios"></tbody>
                </table>

                <input type="datetime-local" id="fechaHora" name="fechaHora" required>
                <button type="submit">Guardar Servicios</button>
            </form>
    </div>


    <script>
        // Obtener el nombre del usuario
        document.addEventListener('DOMContentLoaded', () => {
            const xhrNombreUsuario = new XMLHttpRequest()
            xhrNombreUsuario.open('GET', '/obtener-usuario', true)
            xhrNombreUsuario.onreadystatechange = function () {
                console.log(xhrNombreUsuario);

                if (xhrNombreUsuario.readyState === 4) {
                    if (xhrNombreUsuario.status === 200) {
                        const usuario = JSON.parse(xhrNombreUsuario.responseText)
                        document.getElementById('nombreUsuario').textContent = usuario
                    } else {
                        console.error('No se pudo poner el usuario')
                    }
                }
            }
            xhrNombreUsuario.send()
        })

        fetch('http://localhost:3000/obtenerServiciosManzana')
            .then(datos => datos.json())
            .then(servicios => {
                const tabla = document.getElementById('lista-servicios')
                console.log(servicios);
                
                servicios.forEach(servicio => {
                    console.log(servicio.Nombre_servicio);
                    const fila = document.createElement('tr')

                    const nombre = document.createElement('td')
                    nombre.textContent = servicio.Nombre_servicio
                    fila.appendChild(nombre)

                    const descripcion = document.createElement('td')
                    descripcion.textContent = servicio.Descripcion
                    fila.appendChild(descripcion)

                    const accion = document.createElement('td')
                    const checkbox = document.createElement('input')
                    checkbox.type = 'checkbox'
                    checkbox.value = servicio.id_servicio

                    accion.appendChild(checkbox)
                    fila.appendChild(accion)

                    tabla.appendChild(fila)
                });
                
                // Evento para enviar los servicios seleccionados 
                
                const formularioSeleccionServicio=document.getElementById(
                    'formularioSeleccionServicio');
                formularioSeleccionServicio.addEventListener('submit',async(event)=>{
                    event.preventDefault();
                    const serviciosSeleccionados=Array.from(
                        formularioSeleccionServicio.elements['servicios']
                    )
                    .filter((checkbox) =>checkbox.checked)
                    .map((checkbox) => checkbox.value);
                    const fh = formularioSeleccionServicio.elements['fecha_hora'].value;

                    const xhguardarServicio = new XMLHttpRequest();
                    xhguardarServicio.open("POST", "guardar-servicios", true);
                    xhguardarServicio.setRequestHeader("Content-Type", "application/json");
                    xhguardarServicio.onreadystatechange = function(){
                        if (
                            xhguardarServicio.readyState === 4 &&
                            xhguardarServicio.status === 200
                        ) {
                            alert("Servicios Guardados");
                            windows.location.reload();
                        } else {
                            //Mensaje de error solo si falla la solicitud
                            console.error(
                                "No se pueden cargar los servivios. Estado",
                                xhguardarServicio.status
                            );
                        }
                    };
                    xhguardarServicio.send(JSON.stringify({
                        servicios: serviciosSeleccionados, 
                        fecha_hora: fh
                    }));
                });
            });

    </script>

</body>

</html>